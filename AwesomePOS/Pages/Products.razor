@page "/products"


@inject IDialogService DialogService
@inject IDispatcher Dispatcher
@inject IState<ProductsState> ProductsState
@using System.Globalization;



<MudSpacer />
<MudCard Style="border-radius:10px;" Outlined="true">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Add / Edit Products</MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudForm Model="product">
            <MudTextField @ref="mudTextField" AutoFocus="true" @bind-Value="product.Name" Label="Name" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-4" />
            <MudNumericField Culture=@_en Format="N2" @bind-Value="product.Price" Min="1" Label="Price" Variant="Variant.Outlined" Margin="Margin.Dense" />
        </MudForm>
    </MudCardContent>
    <br />
</MudCard>



<MudAppBar Bottom="true" Fixed="true" Color="Color.Transparent" Elevation="0">
    <MudToolBar    Style="width:100%">
        <MudSpacer />
        <MudButtonGroup Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined" OverrideStyles="true">
            <MudButton Size="Size.Small" StartIcon="@Icons.Material.Filled.Save" IconColor="Color.Success" OnClick="Save">Save</MudButton>
            <MudButton Size="Size.Small" StartIcon="@Icons.Material.Filled.Search" IconColor="Color.Success" OnClick="SearchFunc">Search</MudButton>
            <MudButton Size="Size.Small" IconColor="Color.Error" StartIcon="@Icons.Material.Filled.Cancel">Clear</MudButton>
        </MudButtonGroup>
        <MudSpacer />
    </MudToolBar>
</MudAppBar>




<MudDrawer @bind-Open="@openSearch" Anchor="Anchor.Top" Variant="@DrawerVariant.Temporary" Elevation="1">
    <MudDrawerContainer>
        <MudCard Style="border-radius:10px;margin:15px" Elevation="3" Outlined="true">
            <MudTable Elevation="0" Style="border-radius:15px" Items="@products" Hover="true" Breakpoint="Breakpoint.Sm" T="Product">
                <ToolBarContent>
                    <MudSpacer />
                    <MudTextField @bind-Value="Search" Placeholder="Search For Product..." Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh Style="width:70%">Name</MudTh>
                    <MudTh Style="width:30%">Price</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Name">@context.Name</MudTd>
                    <MudTd DataLabel="Price">@context.Price</MudTd>
                    <MudTd DataLabel="">
                        <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined">
                            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Color="Color.Primary" @onclick="@(()=>Copy(@context))"></MudIconButton>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" @onclick="@(()=>Edit(@context))"></MudIconButton>
                            <MudIconButton @onclick="@(()=>Delete(@context))" Color="Color.Error" Icon="@Icons.Material.Filled.DeleteOutline"></MudIconButton>
                        </MudButtonGroup>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudCard>
    </MudDrawerContainer>
</MudDrawer>




@code {

    public CultureInfo _en = CultureInfo.GetCultureInfo("en-US");
    public string Search { get; set; }
    private Product product = new();
    private bool busy;
    MudTextField<string> mudTextField;
    bool openSearch = false;

    Product[] products => openSearch ? ProductsState.Value.Products : new Product[] { };


    protected override async Task OnInitializedAsync()
    {
        await RefreshListAsync();
    }


    private async Task RefreshListAsync()
    {
        try
        {
            if (!ProductsState.Value.Products.Any())
            {
                Dispatcher.Dispatch(new ProductsLoadAction());
            }
        }
        catch
        {

        }

    }

    private async Task Copy(Product product)
    {
        try
        {
            this.product = new();
            this.product.Name = product.Name;
            this.product.Price = product.Price;
            openSearch = false;
            await mudTextField.FocusAsync();
        }
        catch
        {

        }


    }

    private async Task Edit(Product product)
    {
        try
        {
            this.product = product;
            openSearch = false;
            await mudTextField.FocusAsync();
        }
        catch
        {

        }

    }

    private async void Delete(Product dproduct)
    {
        try
        {
            var confirm = await Dialog.ShowDelete(DialogService);
            if (confirm)
            {
                Dispatcher.Dispatch(new ProductsDeleteAction(dproduct));
                await mudTextField.FocusAsync();
                openSearch = false;
                StateHasChanged();
            }
        }
        catch
        {

        }

    }

    private async Task Save()
    {
        try
        {
            Dispatcher.Dispatch(new ProductsSaveAction(product));
            product = new();
            await mudTextField.FocusAsync();
            openSearch = false;
        }
        catch
        {

        }

    }

    private void SearchFunc()
    {
        openSearch = true;
    }
}
